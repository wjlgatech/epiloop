{
  "project": "stratified-memory-architecture",
  "branchName": "feature/stratified-memory",
  "description": "Implement scalable self-improvement architecture with stratified memory, experience store, and extension system to keep core lean while accumulating wisdom from 1000s of users",
  "parallelization": {
    "enabled": true,
    "maxWorkers": 2
  },
  "userStories": [
    {
      "id": "SCALE-001",
      "title": "Experience Store with Vector Database",
      "description": "As a developer, I want solved problems stored as embeddings so claude-loop gains experience without code bloat",
      "acceptanceCriteria": [
        "Create lib/experience-store.py module",
        "Use ChromaDB or similar lightweight vector DB (file-based, no server)",
        "ExperienceEntry dataclass: problem_signature, solution_approach, context, success_count, last_used, embedding",
        "record_experience(problem, solution, context) -> stores embedding",
        "Embedding via sentence-transformers (all-MiniLM-L6-v2) or hash-based fallback",
        "Store in .claude-loop/experiences/chroma_db/",
        "Auto-create DB on first use",
        "CLI: experience store <problem> <solution> --context <json>",
        "CLI: experience stats (count, size, categories)",
        "Limit DB size to 500MB with LRU eviction of least-used entries"
      ],
      "priority": 1,
      "dependencies": [],
      "fileScope": ["lib/experience-store.py", ".claude-loop/experiences/"],
      "estimatedComplexity": "complex",
      "suggestedModel": "opus",
      "passes": true,
      "notes": "Implemented in commit cbe2802 - Created lib/experience-store.py with ChromaDB/JSON fallback, hash-based embeddings fallback, LRU eviction, and full CLI"
    },
    {
      "id": "SCALE-002",
      "title": "Experience Retriever with RAG",
      "description": "As a developer, I want to retrieve similar past solutions at runtime without adding code",
      "acceptanceCriteria": [
        "Create lib/experience-retriever.py module",
        "retrieve_similar(problem_description, k=5) -> List[ExperienceEntry]",
        "Similarity threshold: only return if cosine similarity > 0.7",
        "Rank by: similarity * success_count * recency_factor",
        "Format retrieved experiences as context for LLM prompt",
        "Update success_count when retrieved solution is used successfully",
        "CLI: experience search <problem> --limit 5",
        "CLI: experience similar <execution_log_id> (find similar past failures)",
        "Integrate into root-cause-analyzer.py: check experiences before LLM call",
        "Cache recent retrievals for performance"
      ],
      "priority": 2,
      "dependencies": ["SCALE-001"],
      "fileScope": ["lib/experience-retriever.py", "lib/root-cause-analyzer.py"],
      "estimatedComplexity": "medium",
      "suggestedModel": "sonnet",
      "passes": false,
      "notes": "RAG-based wisdom retrieval"
    },
    {
      "id": "SCALE-003",
      "title": "Automatic Experience Recording",
      "description": "As a developer, I want successful solutions automatically recorded as experiences",
      "acceptanceCriteria": [
        "Hook into execution-logger.sh: on story completion with passes=true",
        "Extract problem signature from story description + error context",
        "Extract solution approach from git diff of changes made",
        "Record experience automatically after each successful story",
        "Deduplicate: if similar experience exists (>0.9 similarity), increment success_count instead",
        "Add experience_recorded field to execution log entry",
        "CLI: experience record-from-log <log_entry_id>",
        "CLI: experience bulk-record --since <date> (backfill from history)",
        "Skip recording for trivial changes (<10 lines changed)"
      ],
      "priority": 3,
      "dependencies": ["SCALE-001", "SCALE-002"],
      "fileScope": ["lib/experience-recorder.py", "lib/execution-logger.sh"],
      "estimatedComplexity": "medium",
      "suggestedModel": "sonnet",
      "passes": false,
      "notes": "Automatic wisdom accumulation"
    },
    {
      "id": "SCALE-004",
      "title": "Extension System Architecture",
      "description": "As a developer, I want domain-specific capabilities as loadable extensions not core code",
      "acceptanceCriteria": [
        "Create lib/extension-loader.py module",
        "Extension manifest format: extension.json with name, version, capabilities, dependencies",
        "Extensions directory structure: extensions/{name}/extension.json, agents/, prompts/, lib/",
        "load_extension(name) -> loads extension into runtime",
        "list_extensions() -> shows available extensions with status",
        "Extension isolation: extensions cannot modify core files",
        "Extension can register: agents, prompts, CLI commands, hooks",
        "CLI: extension list (available extensions)",
        "CLI: extension enable <name> / extension disable <name>",
        "CLI: extension info <name> (show manifest and capabilities)",
        "Store enabled extensions in .claude-loop/config.json"
      ],
      "priority": 4,
      "dependencies": [],
      "fileScope": ["lib/extension-loader.py", "extensions/", ".claude-loop/config.json"],
      "estimatedComplexity": "complex",
      "suggestedModel": "opus",
      "passes": false,
      "notes": "L1/L2 extension system"
    },
    {
      "id": "SCALE-005",
      "title": "Unity Automation Extension Pack",
      "description": "As a developer, I want Unity automation as an optional extension not core code",
      "acceptanceCriteria": [
        "Create extensions/unity-automation/ directory",
        "Move Unity-specific code from lib/ to extension",
        "Extension manifest with capabilities: gui_automation, unity_editor, vision_click",
        "Extension agents: unity-workflow, panel-detector, element-finder",
        "Extension prompts: unity-specific iteration prompts",
        "Keep core --unity flag but delegate to extension",
        "Graceful error if extension not enabled but --unity used",
        "Add extension enable/disable to --help output",
        "Test: claude-loop works without unity extension loaded",
        "Document extension in extensions/unity-automation/README.md"
      ],
      "priority": 5,
      "dependencies": ["SCALE-004"],
      "fileScope": ["extensions/unity-automation/"],
      "estimatedComplexity": "medium",
      "suggestedModel": "sonnet",
      "passes": false,
      "notes": "First L2 domain pack - proves extension system"
    },
    {
      "id": "SCALE-006",
      "title": "Improvement Tier Classification",
      "description": "As a developer, I want improvements classified into tiers (L0-L3) automatically",
      "acceptanceCriteria": [
        "Create lib/improvement-tier.py module",
        "ImprovementTier enum: L0_CORE, L1_STANDARD, L2_DOMAIN, L3_LOCAL",
        "classify_improvement(prd) -> ImprovementTier based on scope analysis",
        "L3 criteria: affects single project or user-specific",
        "L2 criteria: domain-specific (Unity, React, ML, etc.)",
        "L1 criteria: general-purpose, affects >20% of use cases",
        "L0 criteria: fundamental capability, affects >50% of users",
        "Add tier field to improvement PRD schema",
        "Show tier in --list-improvements output",
        "Filter by tier: --list-improvements --tier L1",
        "Tier affects where improvement code is placed (core vs extension)"
      ],
      "priority": 6,
      "dependencies": ["SCALE-004"],
      "fileScope": ["lib/improvement-tier.py", "lib/improvement-prd-generator.py"],
      "estimatedComplexity": "medium",
      "suggestedModel": "sonnet",
      "passes": false,
      "notes": "Auto-routing improvements to correct tier"
    },
    {
      "id": "SCALE-007",
      "title": "Improvement Lifecycle Manager",
      "description": "As a developer, I want improvements to have a lifecycle with promotion and deprecation",
      "acceptanceCriteria": [
        "Create lib/improvement-lifecycle.py module",
        "Track improvement usage: increment counter each time improvement code is executed",
        "Track improvement success: did it help or cause issues?",
        "Promotion criteria: used 10+ times across 3+ projects -> promote tier",
        "Deprecation criteria: unused for 90 days -> mark deprecated",
        "Deprecation warning: show message when deprecated improvement used",
        "Auto-removal: deprecated + unused 180 days -> remove code",
        "Store lifecycle data in .claude-loop/improvement_lifecycle.json",
        "CLI: improvement lifecycle <prd_name> (show usage stats)",
        "CLI: improvement promote <prd_name> --to L1",
        "CLI: improvement deprecate <prd_name> --reason <text>",
        "CLI: improvement prune --dry-run (show what would be removed)"
      ],
      "priority": 7,
      "dependencies": ["SCALE-006"],
      "fileScope": ["lib/improvement-lifecycle.py", ".claude-loop/improvement_lifecycle.json"],
      "estimatedComplexity": "complex",
      "suggestedModel": "opus",
      "passes": false,
      "notes": "Natural selection for improvements"
    },
    {
      "id": "SCALE-008",
      "title": "Capability Compressor",
      "description": "As a developer, I want similar specific fixes compressed into general capabilities",
      "acceptanceCriteria": [
        "Create lib/capability-compressor.py module",
        "Analyze improvements for common patterns",
        "Cluster improvements by root cause similarity (>0.8 threshold)",
        "If cluster has 5+ improvements, propose generalization",
        "generate_general_capability(cluster) -> single capability that subsumes all",
        "Compression report: shows N specific -> 1 general mapping",
        "CLI: improvement compress --analyze (show compression opportunities)",
        "CLI: improvement compress --execute (perform compression with confirmation)",
        "Keep mapping of original -> compressed for audit",
        "Measure: track code lines saved by compression"
      ],
      "priority": 8,
      "dependencies": ["SCALE-006", "SCALE-007"],
      "fileScope": ["lib/capability-compressor.py"],
      "estimatedComplexity": "complex",
      "suggestedModel": "opus",
      "passes": false,
      "notes": "Prevents N specific fixes, creates M general capabilities"
    },
    {
      "id": "SCALE-009",
      "title": "Anonymized Telemetry Reporter",
      "description": "As a developer, I want to optionally share anonymized failure patterns to help the community",
      "acceptanceCriteria": [
        "Create lib/telemetry-reporter.py module",
        "Opt-in only: disabled by default, explicit enable required",
        "Anonymization: strip file paths, project names, user identifiers",
        "Report only: failure_category, error_type, capability_gap_category, success/failure",
        "No code or file contents ever transmitted",
        "Local aggregation: batch reports, send daily max",
        "Offline storage: queue reports if network unavailable",
        "CLI: telemetry enable / telemetry disable",
        "CLI: telemetry status (show what would be reported)",
        "CLI: telemetry preview (show next batch without sending)",
        "Privacy policy displayed on enable",
        "Store consent in .claude-loop/config.json"
      ],
      "priority": 9,
      "dependencies": ["SCALE-001"],
      "fileScope": ["lib/telemetry-reporter.py", ".claude-loop/config.json"],
      "estimatedComplexity": "medium",
      "suggestedModel": "sonnet",
      "passes": false,
      "notes": "Foundation for federated learning - privacy first"
    },
    {
      "id": "SCALE-010",
      "title": "Core Protection Rules",
      "description": "As a maintainer, I want core code protected from unvalidated changes",
      "acceptanceCriteria": [
        "Create lib/core-protection.py module",
        "Define CORE_FILES list: claude-loop.sh, lib/execution-logger.sh, core modules",
        "is_core_file(path) -> bool",
        "Block autonomous improvements that modify core files",
        "Require --force-core flag to modify core (with warning)",
        "Log all core modification attempts to .claude-loop/core_access.log",
        "Core change requirements check: validate improvement meets criteria",
        "CLI: core list (show protected files)",
        "CLI: core check <prd_name> (verify PRD doesn't touch core)",
        "Integrate with autonomous-gate.py: core changes require human approval",
        "Add core_impact field to improvement PRDs"
      ],
      "priority": 10,
      "dependencies": ["SCALE-006"],
      "fileScope": ["lib/core-protection.py"],
      "estimatedComplexity": "medium",
      "suggestedModel": "sonnet",
      "passes": false,
      "notes": "Keeps L0 core immutable without explicit approval"
    },
    {
      "id": "SCALE-011",
      "title": "Experience-Augmented Prompts",
      "description": "As a developer, I want iteration prompts augmented with relevant past experiences",
      "acceptanceCriteria": [
        "Modify build_iteration_prompt() in claude-loop.sh",
        "Before building prompt, call experience retriever",
        "If relevant experiences found, prepend to prompt as context",
        "Format: '## Relevant Past Experiences\\n{experiences}'",
        "Limit to top 3 most relevant experiences",
        "Include: problem summary, solution approach, success rate",
        "Skip if no experiences above similarity threshold",
        "Log when experiences are used: experience_augmented=true in execution log",
        "Measure: track success rate with vs without experience augmentation",
        "Add --no-experience flag to disable augmentation for testing"
      ],
      "priority": 11,
      "dependencies": ["SCALE-002", "SCALE-003"],
      "fileScope": ["claude-loop.sh", "lib/prompt-augmenter.py"],
      "estimatedComplexity": "medium",
      "suggestedModel": "sonnet",
      "passes": false,
      "notes": "Wisdom retrieval at runtime"
    },
    {
      "id": "SCALE-012",
      "title": "Scale Metrics Dashboard",
      "description": "As a developer, I want to monitor the health of the stratified memory system",
      "acceptanceCriteria": [
        "Add /scale-metrics endpoint to dashboard/app.py",
        "Show: experience store size, entry count, retrieval latency",
        "Show: extension count (enabled/available), extension usage",
        "Show: improvement tiers distribution (L0/L1/L2/L3 counts)",
        "Show: lifecycle stats (active, deprecated, promoted, removed)",
        "Show: compression ratio (original improvements vs compressed)",
        "Show: experience hit rate (% of problems with relevant experience)",
        "Show: core protection events (blocked modifications)",
        "Export metrics as JSON for external monitoring",
        "Alert if: experience DB >400MB, retrieval latency >200ms, core violations"
      ],
      "priority": 12,
      "dependencies": ["SCALE-001", "SCALE-004", "SCALE-007"],
      "fileScope": ["dashboard/app.py", "dashboard/templates/scale_metrics.html"],
      "estimatedComplexity": "medium",
      "suggestedModel": "sonnet",
      "passes": false,
      "notes": "Visibility into system health at scale"
    },
    {
      "id": "SCALE-013",
      "title": "Experience Sync Protocol",
      "description": "As a team, I want to share experiences across team members' instances",
      "acceptanceCriteria": [
        "Create lib/experience-sync.py module",
        "Export experiences to portable format: experiences.jsonl.gz",
        "Import experiences from file (merge with deduplication)",
        "Sync modes: manual export/import, shared folder watch, git-based",
        "Conflict resolution: keep higher success_count version",
        "CLI: experience export --output experiences.jsonl.gz",
        "CLI: experience import <file> --merge",
        "CLI: experience sync --folder /shared/experiences/ (watch mode)",
        "Filter export: --min-success 3 --categories 'UI,API'",
        "Show sync status in dashboard",
        "Privacy: no automatic cloud sync, local/team only"
      ],
      "priority": 13,
      "dependencies": ["SCALE-001", "SCALE-002"],
      "fileScope": ["lib/experience-sync.py"],
      "estimatedComplexity": "medium",
      "suggestedModel": "sonnet",
      "passes": false,
      "notes": "Team knowledge sharing without central server"
    },
    {
      "id": "SCALE-014",
      "title": "Extension Marketplace Spec",
      "description": "As a developer, I want to discover and install community extensions",
      "acceptanceCriteria": [
        "Create lib/extension-registry.py module",
        "Registry format: JSON index of available extensions with metadata",
        "Support multiple registries: official, community, private",
        "CLI: extension search <query> (search registry)",
        "CLI: extension install <name> (download and enable)",
        "CLI: extension update <name> (update to latest version)",
        "CLI: extension uninstall <name> (remove extension)",
        "Verify extension signatures (optional, warn if unsigned)",
        "Cache registry locally, refresh on demand",
        "Default registry: github raw file or similar static hosting",
        "Document how to publish extension to registry"
      ],
      "priority": 14,
      "dependencies": ["SCALE-004", "SCALE-005"],
      "fileScope": ["lib/extension-registry.py", "docs/EXTENSION-PUBLISHING.md"],
      "estimatedComplexity": "complex",
      "suggestedModel": "opus",
      "passes": false,
      "notes": "Community extension ecosystem"
    },
    {
      "id": "SCALE-015",
      "title": "Integration Tests for Scale Architecture",
      "description": "As a developer, I want comprehensive tests for the stratified memory system",
      "acceptanceCriteria": [
        "Create tests/test_scale_architecture.py",
        "Test: experience store CRUD operations",
        "Test: experience retrieval with similarity thresholds",
        "Test: automatic experience recording on success",
        "Test: extension loading and isolation",
        "Test: improvement tier classification accuracy",
        "Test: lifecycle promotion and deprecation",
        "Test: capability compression correctness",
        "Test: core protection blocks unauthorized changes",
        "Test: experience augmentation in prompts",
        "Test: experience sync export/import round-trip",
        "Use mock embeddings for deterministic tests",
        "Measure: test coverage >80% for new modules"
      ],
      "priority": 15,
      "dependencies": ["SCALE-001", "SCALE-002", "SCALE-003", "SCALE-004", "SCALE-006", "SCALE-007", "SCALE-008", "SCALE-010", "SCALE-011", "SCALE-013"],
      "fileScope": ["tests/test_scale_architecture.py"],
      "estimatedComplexity": "complex",
      "suggestedModel": "opus",
      "passes": false,
      "notes": "Ensures scale architecture works correctly"
    }
  ]
}
