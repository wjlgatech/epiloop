{
  "project": "parallel-prd-support",
  "title": "Parallel PRD Execution Support",
  "branchName": "feature/parallel-prd-support",
  "description": "Enable Claude-Loop to execute multiple PRDs in parallel using git worktrees, coordinator pattern, and isolated state management. Provides 3x-5x throughput improvement while maintaining safety and observability.",
  "complexityLevel": 4,
  "architecture": {
    "patterns": [
      "Coordinator Pattern",
      "Git Worktrees for Isolation",
      "File-Based Locking",
      "Process Supervision"
    ],
    "components": [
      "PRD Coordinator (lib/prd-coordinator.sh)",
      "Registry Management",
      "Worktree Lifecycle Manager",
      "Resource Limiter",
      "Unified Dashboard"
    ]
  },
  "references": [
    "docs/adrs/adr-003-parallel-prd-execution.md",
    "docs/architecture/parallel-prd-implementation-plan.md"
  ],
  "userStories": [
    {
      "id": "PAR-001",
      "title": "Create PRD Coordinator Script Foundation",
      "description": "Create the foundational prd-coordinator.sh script with basic structure, logging, and configuration management.",
      "priority": 1,
      "complexity": "medium",
      "dependencies": [],
      "passes": false,
      "acceptanceCriteria": [
        "lib/prd-coordinator.sh exists and is executable with proper shebang",
        "Creates .claude-loop/coordinator/ directory structure on initialization",
        "Loads configuration from environment variables and CLI args",
        "Provides logging functions: coord_log_info, coord_log_error, coord_log_warn",
        "Shows version and help message with --help flag",
        "Returns appropriate exit codes (0=success, 1=error)"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Script runs without errors",
        "Help output is informative",
        "Directory structure created correctly"
      ]
    },
    {
      "id": "PAR-002",
      "title": "Implement PRD Registry Management",
      "description": "Create the PRD registry with atomic operations for tracking active PRD executions, using file-based locking to prevent race conditions.",
      "priority": 1,
      "complexity": "medium",
      "dependencies": ["PAR-001"],
      "passes": false,
      "acceptanceCriteria": [
        "Registry JSON schema defined and documented in code comments",
        "init_registry() creates registry.json with proper structure",
        "register_prd() atomically adds PRD to registry using flock",
        "deregister_prd() atomically removes PRD from registry",
        "list_active_prds() returns array of active PRD IDs",
        "get_prd_info() returns detailed info for specific PRD",
        "Concurrent register calls don't corrupt registry (tested)",
        "Registry persists across coordinator restarts"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test concurrent registrations (simulate with background processes)",
        "Test registry integrity after multiple updates",
        "Test query functions return correct data"
      ]
    },
    {
      "id": "PAR-003",
      "title": "Implement Git Worktree Lifecycle Management",
      "description": "Add functions to create and manage git worktrees for isolated PRD execution, with branch conflict detection and safe cleanup.",
      "priority": 1,
      "complexity": "high",
      "dependencies": ["PAR-002"],
      "passes": false,
      "acceptanceCriteria": [
        "create_prd_worktree() creates worktree at .claude-loop/worktrees/<PRD-ID>/",
        "Worktree uses branch feature/<PRD-ID> or PRD.branchName if specified",
        "detect_branch_conflict() checks if branch is already in use",
        "Branch name appends suffix if conflict detected (e.g., feature/PRD-001-1)",
        "remove_prd_worktree() safely removes worktree and branch",
        "Handles git errors gracefully with informative error messages",
        "Preserves worktrees on failure (--keep-on-failure option)",
        "Validates worktree exists before operations"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test worktree creation with valid PRD",
        "Test branch conflict detection and resolution",
        "Test worktree removal (success and failure cases)",
        "Test error handling for invalid git state"
      ]
    },
    {
      "id": "PAR-004",
      "title": "Add Resource Limit Enforcement",
      "description": "Implement configurable limits on parallel PRDs and worker processes to prevent system overload.",
      "priority": 2,
      "complexity": "medium",
      "dependencies": ["PAR-002"],
      "passes": false,
      "acceptanceCriteria": [
        "PARALLEL_MAX_PRDS config variable (default: 3)",
        "can_start_prd() returns true/false based on current active count",
        "queue_prd() adds PRD to waiting queue when limit reached",
        "start_next_queued_prd() automatically starts when slot available",
        "get_resource_utilization() returns current/max for PRDs and workers",
        "Resource limits configurable via CLI flags --max-prds",
        "Registry tracks queued PRDs with timestamps"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test max limit enforcement (try to start N+1 PRDs)",
        "Test queueing and auto-start behavior",
        "Test configuration override via CLI"
      ]
    },
    {
      "id": "PAR-005",
      "title": "Implement File-Based API Rate Limiting",
      "description": "Create a semaphore-based system for limiting concurrent Claude API requests across all PRD workers.",
      "priority": 2,
      "complexity": "high",
      "dependencies": ["PAR-002"],
      "passes": false,
      "acceptanceCriteria": [
        "PARALLEL_API_LIMIT config variable (default: 10 concurrent)",
        "acquire_api_token() atomically acquires token using flock",
        "release_api_token() atomically releases token",
        "Token counter stored in .claude-loop/coordinator/api_tokens",
        "Acquisition blocks until token available (with timeout)",
        "Tokens auto-released on worker crash/exit",
        "get_api_utilization() returns current/max tokens in use",
        "Lock file at .claude-loop/coordinator/locks/api_limit.lock"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test token acquisition and release",
        "Test max limit enforcement (attempt N+1 acquisitions)",
        "Test token cleanup on process exit",
        "Test concurrent token operations"
      ]
    },
    {
      "id": "PAR-006",
      "title": "Create PRD Worker Launcher",
      "description": "Implement the worker launcher that starts claude-loop.sh in a worktree as a background process with proper environment setup.",
      "priority": 1,
      "complexity": "high",
      "dependencies": ["PAR-003", "PAR-004", "PAR-005"],
      "passes": false,
      "acceptanceCriteria": [
        "launch_prd_worker() starts claude-loop.sh in worktree directory",
        "Worker runs as background process with PID tracked",
        "Worker stdout/stderr redirected to .claude-loop/coordinator/logs/<PRD-ID>.log",
        "Worker receives isolated .claude-loop/ state directory",
        "Worker exit code written to <worktree>/.claude-loop/exit_code",
        "Environment variables properly inherited by worker",
        "Worker launch failures handled gracefully",
        "Multiple workers can run simultaneously without interference"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test worker launch and PID tracking",
        "Test log file creation and capture",
        "Test multiple workers running in parallel",
        "Test worker environment isolation"
      ]
    },
    {
      "id": "PAR-007",
      "title": "Modify claude-loop.sh for Coordinator Mode",
      "description": "Add --parallel flag to claude-loop.sh to enable coordinator mode for launching multiple PRD workers.",
      "priority": 1,
      "complexity": "medium",
      "dependencies": ["PAR-006"],
      "passes": false,
      "acceptanceCriteria": [
        "Adds --parallel flag to claude-loop.sh argument parsing",
        "Detects coordinator vs worker mode (worker mode is default)",
        "Coordinator mode sources lib/prd-coordinator.sh",
        "Coordinator mode auto-detects PRDs in prds/active/ if no PRDs specified",
        "Accepts multiple PRD IDs with --parallel: ./claude-loop.sh --parallel PRD-001 PRD-002",
        "Worker mode behavior unchanged (backward compatible)",
        "Adds --max-prds flag for resource limit configuration",
        "Help text updated with parallel mode documentation"
      ],
      "fileScope": [
        "claude-loop.sh"
      ],
      "testRequirements": [
        "Test --parallel flag enables coordinator mode",
        "Test PRD auto-detection in parallel mode",
        "Test multiple PRD specification",
        "Test worker mode unchanged (regression test)"
      ]
    },
    {
      "id": "PAR-008",
      "title": "Implement Worker Monitoring and Health Checks",
      "description": "Add monitoring system to track worker health, detect failures, and update registry status in real-time.",
      "priority": 2,
      "complexity": "medium",
      "dependencies": ["PAR-006"],
      "passes": false,
      "acceptanceCriteria": [
        "monitor_workers() polls all active workers every 10 seconds",
        "Detects crashed workers (PID no longer exists)",
        "Detects hung workers (no progress update in 15 minutes)",
        "Updates registry with worker status: running/failed/hung/complete",
        "is_worker_alive() checks if worker process exists",
        "get_worker_progress() reads progress from worker state",
        "Logs worker status changes to metrics.jsonl",
        "Optional PARALLEL_AUTO_RESTART flag to restart failed workers"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test detection of crashed worker (kill process)",
        "Test detection of hung worker (simulate no progress)",
        "Test registry status updates",
        "Test auto-restart if enabled"
      ]
    },
    {
      "id": "PAR-009",
      "title": "Add Worker Completion Handling",
      "description": "Implement post-completion workflow including cleanup, archival, and starting next queued PRD.",
      "priority": 2,
      "complexity": "medium",
      "dependencies": ["PAR-008"],
      "passes": false,
      "acceptanceCriteria": [
        "Detects worker completion via exit code check",
        "on_worker_complete() executes cleanup workflow",
        "Moves prds/active/<PRD-ID> to prds/completed/<PRD-ID>",
        "Optional auto-merge to main if COORDINATOR_AUTO_MERGE=true",
        "Archives worktree state to .claude-loop/archives/<PRD-ID>-worktree.tar.gz",
        "Removes worktree if WORKTREE_CLEANUP_ON_SUCCESS=true",
        "Deregisters PRD from coordinator registry",
        "Automatically starts next queued PRD if any",
        "Logs completion metrics (duration, stories completed)"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test completion detection and cleanup",
        "Test PRD move to completed/",
        "Test worktree cleanup",
        "Test auto-start of queued PRD"
      ]
    },
    {
      "id": "PAR-010",
      "title": "Create Unified Progress Dashboard",
      "description": "Build a real-time terminal dashboard showing progress of all active PRDs with color-coded status.",
      "priority": 1,
      "complexity": "high",
      "dependencies": ["PAR-008"],
      "passes": false,
      "acceptanceCriteria": [
        "render_dashboard() displays formatted terminal dashboard",
        "Shows all active PRDs with individual progress bars",
        "Color-coded status indicators (green=running, red=failed, yellow=hung)",
        "Displays current story and iteration per PRD",
        "Shows runtime (HH:MM:SS) for each PRD",
        "Shows queued PRDs list",
        "Resource utilization summary (API tokens, active workers, CPU%)",
        "Updates every COORDINATOR_DASHBOARD_REFRESH seconds (default: 1)",
        "Dashboard clears and redraws for smooth updates",
        "Handles terminal resize gracefully"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test dashboard rendering with multiple PRDs",
        "Test progress bar calculations",
        "Test color output (visual verification)",
        "Test dashboard updates"
      ]
    },
    {
      "id": "PAR-011",
      "title": "Add --status Command for Monitoring",
      "description": "Implement CLI command to display coordinator status and PRD progress without starting execution.",
      "priority": 2,
      "complexity": "low",
      "dependencies": ["PAR-010"],
      "passes": false,
      "acceptanceCriteria": [
        "Adds --status flag to claude-loop.sh",
        "./claude-loop.sh --status shows dashboard snapshot",
        "Works when coordinator is running or stopped",
        "Supports --status --json for JSON output",
        "Supports --status <PRD-ID> to show single PRD details",
        "JSON output includes all registry data",
        "Shows historical data from registry if coordinator not running",
        "Exit code 0 if all PRDs healthy, 1 if any failures"
      ],
      "fileScope": [
        "claude-loop.sh",
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test status display with running coordinator",
        "Test status display with stopped coordinator",
        "Test JSON output format",
        "Test single PRD filtering"
      ]
    },
    {
      "id": "PAR-012",
      "title": "Implement Aggregate Metrics Logging",
      "description": "Create structured logging system for coordinator events and metrics for analysis and monitoring.",
      "priority": 3,
      "complexity": "low",
      "dependencies": ["PAR-009"],
      "passes": false,
      "acceptanceCriteria": [
        "Creates .claude-loop/coordinator/metrics.jsonl (JSONL format)",
        "log_metric() appends events with timestamps",
        "Logs PRD lifecycle events: started, completed, failed",
        "Logs resource utilization samples every minute",
        "Calculates aggregate throughput (PRDs/hour)",
        "Tracks API usage across all PRDs",
        "Each line is valid JSON for easy parsing",
        "Metrics rotated when file exceeds 10MB"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test metric logging format",
        "Test JSONL validity (each line parseable)",
        "Test file rotation",
        "Test aggregate calculations"
      ]
    },
    {
      "id": "PAR-013",
      "title": "Implement Graceful Shutdown Handler",
      "description": "Add signal handlers for graceful coordinator shutdown that stops workers cleanly and preserves state.",
      "priority": 1,
      "complexity": "medium",
      "dependencies": ["PAR-008"],
      "passes": false,
      "acceptanceCriteria": [
        "Trap SIGINT and SIGTERM signals",
        "on_shutdown() stops all active workers with SIGTERM",
        "Waits up to 60 seconds for workers to finish current iteration",
        "Force kills workers (SIGKILL) after timeout",
        "Saves coordinator registry state before exit",
        "Preserves worktrees for resume capability",
        "Logs shutdown event to metrics",
        "Exit code reflects shutdown reason (0=clean, 1=forced)"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh",
        "claude-loop.sh"
      ],
      "testRequirements": [
        "Test Ctrl+C triggers shutdown",
        "Test graceful worker stop",
        "Test forced kill after timeout",
        "Test state preservation"
      ]
    },
    {
      "id": "PAR-014",
      "title": "Add PRD Failure Isolation",
      "description": "Ensure that failure of one PRD doesn't affect other running PRDs, with proper error logging and worktree preservation.",
      "priority": 2,
      "complexity": "medium",
      "dependencies": ["PAR-008"],
      "passes": false,
      "acceptanceCriteria": [
        "on_worker_failure() handles worker failures",
        "Failed PRD marked as 'failed' in registry with error details",
        "Failed worktree preserved if WORKTREE_CLEANUP_ON_FAILURE=false",
        "Other PRDs continue running unaffected",
        "Failure logged to metrics.jsonl with error message",
        "Queued PRDs continue to start normally",
        "Optional COORDINATOR_AUTO_RETRY attempts to restart failed PRD",
        "Failure notification includes PRD ID and error"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test failure isolation (fail 1 PRD, verify others continue)",
        "Test worktree preservation on failure",
        "Test error logging",
        "Test auto-retry if enabled"
      ]
    },
    {
      "id": "PAR-015",
      "title": "Add Coordinator State Persistence and Resume",
      "description": "Enable coordinator to resume interrupted parallel execution by detecting and reattaching to running workers.",
      "priority": 3,
      "complexity": "high",
      "dependencies": ["PAR-013", "PAR-014"],
      "passes": false,
      "acceptanceCriteria": [
        "Auto-saves coordinator state every 60 seconds",
        "On startup, detects previous session from registry",
        "Prompts user: 'Resume previous session? [Y/n]'",
        "resume_coordinator() reattaches to running workers by PID validation",
        "Detects and cleans up orphaned workers (PID doesn't exist)",
        "Restores queue order from saved state",
        "Handles corrupted registry gracefully (backup from archive)",
        "Adds --resume flag to force resume without prompt"
      ],
      "fileScope": [
        "lib/prd-coordinator.sh",
        "claude-loop.sh"
      ],
      "testRequirements": [
        "Test resume after clean shutdown",
        "Test resume after crash (orphaned workers)",
        "Test PID reattachment",
        "Test orphan cleanup"
      ]
    },
    {
      "id": "PAR-016",
      "title": "Add --stop Command for Worker Control",
      "description": "Implement CLI commands to stop specific PRDs or all PRDs gracefully during execution.",
      "priority": 2,
      "complexity": "low",
      "dependencies": ["PAR-013"],
      "passes": false,
      "acceptanceCriteria": [
        "Adds --stop <PRD-ID> command to claude-loop.sh",
        "./claude-loop.sh --stop PRD-001 stops specific worker",
        "Adds --stop-all command to stop all workers",
        "Sends SIGTERM first, then SIGKILL after 30s timeout",
        "Updates registry status to 'stopped'",
        "Preserves worktree for manual inspection or resume",
        "Logs stop event to metrics",
        "Exit code 0 if stopped successfully"
      ],
      "fileScope": [
        "claude-loop.sh",
        "lib/prd-coordinator.sh"
      ],
      "testRequirements": [
        "Test stop specific PRD",
        "Test stop all PRDs",
        "Test graceful vs forced stop",
        "Test registry update"
      ]
    },
    {
      "id": "PAR-017",
      "title": "Enhance Help and Documentation",
      "description": "Update help text and create comprehensive documentation for parallel PRD execution feature.",
      "priority": 3,
      "complexity": "low",
      "dependencies": ["PAR-001", "PAR-007", "PAR-011", "PAR-016"],
      "passes": false,
      "acceptanceCriteria": [
        "claude-loop.sh --help includes parallel mode section",
        "Documents all parallel flags: --parallel, --max-prds, --status, --stop",
        "Provides examples for common workflows",
        "Creates docs/guides/parallel-prd-guide.md with architecture overview",
        "Creates docs/troubleshooting-parallel.md for common issues",
        "Documents configuration options and environment variables",
        "Includes performance tuning guide",
        "README.md updated with parallel execution summary"
      ],
      "fileScope": [
        "claude-loop.sh",
        "docs/guides/parallel-prd-guide.md",
        "docs/troubleshooting-parallel.md",
        "README.md"
      ],
      "testRequirements": [
        "Verify help text accuracy",
        "Verify examples work as documented"
      ]
    },
    {
      "id": "PAR-018",
      "title": "Add Comprehensive Integration Tests",
      "description": "Create integration test suite to validate parallel PRD execution across various scenarios including failures.",
      "priority": 3,
      "complexity": "high",
      "dependencies": ["PAR-014", "PAR-015"],
      "passes": false,
      "acceptanceCriteria": [
        "Creates tests/integration/test_parallel_prd.sh test suite",
        "Test 1: Execute 3 PRDs in parallel, verify all complete",
        "Test 2: Resource limit enforcement (5 PRDs, limit=3)",
        "Test 3: Failure isolation (fail 1 PRD, verify others continue)",
        "Test 4: Graceful shutdown (SIGINT during execution)",
        "Test 5: Resume after interruption",
        "Test 6: Branch conflict detection and resolution",
        "Test 7: API rate limiting enforcement",
        "Test 8: Dashboard rendering and updates",
        "All tests pass on macOS (bash 3.x) and Linux (bash 4.x)",
        "Test fixtures in tests/fixtures/parallel/"
      ],
      "fileScope": [
        "tests/integration/test_parallel_prd.sh",
        "tests/integration/test_coordinator.sh",
        "tests/fixtures/parallel/"
      ],
      "testRequirements": [
        "All integration tests pass",
        "Tests are idempotent (can run multiple times)",
        "Tests clean up worktrees and state after execution"
      ]
    }
  ],
  "parallelization": {
    "enabled": true,
    "groups": [
      {
        "name": "Foundation",
        "stories": ["PAR-001", "PAR-002"],
        "maxParallel": 2
      },
      {
        "name": "Core Infrastructure",
        "stories": ["PAR-003", "PAR-004", "PAR-005"],
        "maxParallel": 3
      },
      {
        "name": "Worker Management",
        "stories": ["PAR-006", "PAR-007"],
        "maxParallel": 2
      },
      {
        "name": "Monitoring",
        "stories": ["PAR-008", "PAR-009", "PAR-010"],
        "maxParallel": 2
      },
      {
        "name": "CLI Enhancement",
        "stories": ["PAR-011", "PAR-012"],
        "maxParallel": 2
      },
      {
        "name": "Safety",
        "stories": ["PAR-013", "PAR-014", "PAR-015"],
        "maxParallel": 2
      },
      {
        "name": "Polish",
        "stories": ["PAR-016", "PAR-017", "PAR-018"],
        "maxParallel": 3
      }
    ]
  },
  "metadata": {
    "created": "2026-01-12T21:30:00Z",
    "author": "Claude Sonnet 4.5",
    "version": "1.0.0",
    "estimatedEffort": "15-22 days",
    "tags": ["performance", "concurrency", "infrastructure", "coordinator-pattern"]
  }
}
