{% extends "base.html" %}

{% block title %}Run {{ run_id }} - Claude-Loop Dashboard{% endblock %}

{% block extra_styles %}
<style>
    .chart-container {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 1rem auto;
    }

    .bar-chart {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .bar-row {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .bar-label {
        min-width: 140px;
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-align: right;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .bar-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .bar {
        height: 24px;
        background: var(--accent-primary);
        border-radius: 4px;
        min-width: 2px;
        transition: width 0.3s ease;
    }

    .bar-value {
        font-size: 0.875rem;
        color: var(--text-primary);
        white-space: nowrap;
    }

    .lessons-card {
        margin-bottom: 1rem;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: var(--border-radius);
        border-left: 3px solid var(--accent-primary);
    }

    .lessons-story {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .lessons-list {
        margin: 0;
        padding-left: 1.5rem;
        color: var(--text-secondary);
    }

    .lessons-list li {
        margin-bottom: 0.25rem;
    }

    .grid-2col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    @media (max-width: 768px) {
        .grid-2col {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<h1>Run Details: {{ run_id|format_timestamp }}</h1>

{# Run Summary Section #}
{% if summary %}
<div class="stat-grid">
    <div class="stat-card">
        <div class="stat-value">{{ summary.project|default('Unknown') }}</div>
        <div class="stat-label">Project</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ summary.total_cost|default(0)|format_cost }}</div>
        <div class="stat-label">Total Cost</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ summary.stories_completed|default(0) }}/{{ summary.stories_total|default('?') }}</div>
        <div class="stat-label">Stories Completed</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ summary.total_duration_ms|default(0)|format_duration }}</div>
        <div class="stat-label">Duration</div>
    </div>
</div>

{% if summary.branch %}
<div class="card">
    <h2>Branch</h2>
    <p><code>{{ summary.branch }}</code></p>
</div>
{% endif %}

{% if summary.status %}
<div class="card">
    <h2>Status</h2>
    <span class="status-badge {% if summary.status == 'complete' %}status-complete{% elif summary.status == 'error' %}status-error{% else %}status-running{% endif %}">
        {{ summary.status|capitalize }}
    </span>
</div>
{% endif %}
{% endif %}

{# Iteration Details Table #}
{% if metrics and metrics.iterations %}
<div class="card">
    <h2>Iterations</h2>
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Story</th>
                <th>Agents</th>
                <th>Tokens In</th>
                <th>Tokens Out</th>
                <th>Cost</th>
                <th>Duration</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for iteration in metrics.iterations %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>
                    <strong>{{ iteration.story_id|default('N/A') }}</strong>
                    {% if iteration.story_title %}
                    <br><small style="color: var(--text-secondary);">{{ iteration.story_title }}</small>
                    {% endif %}
                </td>
                <td>
                    {% set agents = iteration.agents_used %}
                    {% if agents is string %}
                        {{ agents or 'None' }}
                    {% else %}
                        {{ agents|join(', ') or 'None' }}
                    {% endif %}
                </td>
                <td>{{ "{:,}".format(iteration.tokens_in|default(0)) }}</td>
                <td>{{ "{:,}".format(iteration.tokens_out|default(0)) }}</td>
                <td>{{ iteration.cost_usd|default(0)|format_cost }}</td>
                <td>{{ iteration.duration_ms|default(0)|format_duration }}</td>
                <td>
                    {% if iteration.status == 'complete' %}
                        <span class="status-badge status-complete">Complete</span>
                    {% elif iteration.status == 'error' %}
                        <span class="status-badge status-error">Error</span>
                    {% else %}
                        <span class="status-badge status-running">{{ iteration.status|default('Unknown') }}</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{# Agent Cost Breakdown Chart #}
{% if agent_costs %}
<div class="card">
    <h2>Cost Breakdown by Agent</h2>
    <div class="chart-container">
        <div class="bar-chart">
            {% set max_cost = namespace(value=0) %}
            {% for agent in agent_costs %}
                {% if agent.total_cost > max_cost.value %}
                    {% set max_cost.value = agent.total_cost %}
                {% endif %}
            {% endfor %}

            {% for agent in agent_costs %}
            <div class="bar-row">
                <div class="bar-label" title="{{ agent.agent }}">
                    {{ agent.agent }} ({{ agent.count }}Ã—)
                </div>
                <div class="bar-wrapper">
                    {% set bar_width = (agent.total_cost / max_cost.value * 100) if max_cost.value > 0 else 0 %}
                    <div class="bar" style="width: {{ bar_width }}%;"></div>
                    <span class="bar-value">{{ agent.total_cost|format_cost }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{# Lessons Learned Section #}
{% if lessons_learned %}
<div class="card">
    <h2>Lessons Learned</h2>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        Insights discovered during this run that may help future iterations:
    </p>
    {% for lesson in lessons_learned %}
    <div class="lessons-card">
        <div class="lessons-story">{{ lesson.story }}</div>
        <ul class="lessons-list">
            {% for learning in lesson.learnings %}
            <li>{{ learning }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}
</div>
{% endif %}

{# Improvement Suggestions #}
{% if improvements and improvements.suggestions %}
<div class="card">
    <h2>Improvement Suggestions</h2>
    {% for suggestion in improvements.suggestions %}
    <div style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--border-radius);">
        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <strong>{{ suggestion.title|default('Suggestion') }}</strong>
            <span class="status-badge {% if suggestion.priority == 'high' %}status-error{% elif suggestion.priority == 'medium' %}status-running{% else %}status-complete{% endif %}">
                {{ suggestion.priority|default('medium')|upper }}
            </span>
        </div>
        <p style="color: var(--text-secondary);">{{ suggestion.description|default('') }}</p>
        {% if suggestion.actions %}
        <ul style="margin-top: 0.5rem; margin-left: 1.5rem; color: var(--text-secondary);">
            {% for action in suggestion.actions %}
            <li>{{ action }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<div style="margin-top: 2rem;">
    <a href="/" class="btn">Back to Runs</a>
    <a href="/api/run/{{ run_id }}" class="btn btn-secondary" target="_blank">View JSON</a>
    {% if has_report %}
    <a href="/report/{{ run_id }}" class="btn btn-secondary">View HTML Report</a>
    {% endif %}
</div>
{% endblock %}
